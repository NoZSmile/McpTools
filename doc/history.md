# 开发历史记录

## 1. 添加 SSE (Server-Sent Events) 支持

按照 doc/sse.md 中的步骤，实现了 SSE 支持，使工具能够通过 Web 实时推送数据：

1. 创建了项目结构：
   - src/server 目录存放 SSE 服务器代码
   - src/config 目录用于配置管理
   - src/server/public 目录存放示例客户端页面

2. 实现了配置管理模块：
   - 支持从配置文件、环境变量和命令行参数获取配置
   - 配置优先级：命令行参数 > 环境变量 > 配置文件 > 默认配置

3. 实现了 SSE 服务器：
   - 基于 Express 的 HTTP 服务器
   - 支持客户端连接管理
   - 实现事件发送功能
   - 支持心跳包和连接超时管理

4. 实现了 API 路由：
   - 为每个 MCP 工具创建 API 端点
   - 支持客户端验证和参数验证
   - 处理异步操作和错误处理

5. 创建了客户端示例：
   - HTML/JS 示例页面，展示如何连接和使用 SSE 服务
   - 支持工具选择和参数配置
   - 实时显示操作结果

6. 修改了入口文件：
   - 支持通过命令行参数启动 SSE 模式
   - 保留原有的命令行功能
   - 优化代码结构

7. 创建了配置文件示例：
   - config.json.example 作为配置参考

8. 完善了客户端示例：
   - 创建了一个完整的HTML/JS客户端示例页面
   - 实现了SSE连接管理和事件监听
   - 提供了工具选择和参数配置界面
   - 支持实时展示事件和结果
   - 针对不同工具提供默认参数模板
   - 使用响应式设计，美观易用

9. 更新了项目文档：
   - 在README.md中添加了SSE模式的详细说明
   - 增加了SSE配置说明和API端点文档
   - 提供了JavaScript客户端使用示例代码
   - 更新了命令行说明，添加SSE相关参数

10. 修复README.md中的SSE参数格式不一致问题：
   - 将文档中的`--sse`参数格式修改为与实际代码实现一致的`sse`命令格式
   - 更新了基本使用部分的命令示例
   - 更新了详细命令表格中的命令格式
   - 更新了SSE模式使用指南中的启动服务示例
   - 保持文档与代码实现的一致性，避免用户混淆

11. 修复API请求中客户端ID传递方式的问题：
   - 将客户端ID从请求体(req.body)改为查询参数(req.query)传递
   - 修改validateClientId函数，使其从查询参数中获取clientId
   - 更新所有API路由处理函数，使其从查询参数中获取clientId
   - 保持前端页面中的请求方式不变，确保正确传递clientId
   - 解决了400 Bad Request错误问题

12. 修复API响应中缺少requestId导致前端显示"请求已发送，ID: unknown"的问题：
   - 在所有API路由处理函数中添加了requestId生成逻辑
   - 在API响应中添加requestId字段，使前端能够正确显示请求ID
   - 在所有事件（start、complete、error）中添加requestId字段，便于前端跟踪请求
   - 修复了now工具的参数名称，从offset改为format，与前端保持一致
   - 修复了now工具的getNowTime调用，添加了await关键字

13. 修复SSE客户端没有显示工具执行结果的问题：
   - 在前端页面中添加了对start、complete和error事件的监听器
   - 优化了日志显示格式，使结果显示更加清晰
   - 添加了美化JSON输出的功能
   - 改进了时间戳显示，增加毫秒精度
   - 添加了新的CSS样式，使结果显示更加美观

14. 修复"now"工具返回"Invalid Date"错误的问题：
   - 修正了参数不匹配问题：前端发送format参数但后端getNowTime函数需要offset参数
   - 在服务器端API路由处理函数中，将format参数转换为offset参数
   - 修改前端页面中的默认参数，从format改为offset
   - 保持与mcp工具定义中的参数一致性

15. 改进结果界面显示效果，添加自动换行功能：
   - 为事件元素(.event)添加文本自动换行属性(word-wrap, word-break, overflow-wrap)
   - 优化代码块(pre)元素的显示，确保长代码和JSON能够自动换行
   - 提高结果界面整体可读性，防止内容溢出容器
   - 解决长URL和长文本显示不全的问题

16. 修复浏览器模式获取网页内容时的连接错误问题：
   - 修改browsePage函数，增加重试机制，避免因单次连接错误导致请求失败
   - 移除browsePage函数中的浏览器关闭操作，防止后续请求无法使用同一浏览器实例
   - 增强Browser类的错误处理能力，添加连接状态检查和自动重连机制
   - 针对特定连接错误（Protocol error、Connection closed、Target closed）实现特殊处理
   - 优化页面资源释放逻辑，确保在出错时正确关闭页面
   - 提升系统稳定性和容错能力，使浏览器模式更可靠
